<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('layouts/header', { title: 'G2 Registration' }) %>
    <link href="/css/styles.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" rel="stylesheet">
    <style>
        .slot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        .slot-btn {
            width: 100%;
            padding: 10px;
        }
        .slot-btn.selected {
            background-color: #007bff;
            color: white;
        }
        .btn-primary {
            margin-top: 20px;
            padding: 10px 20px;
            border-radius: 8px;
            background-color: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        #timeSlotsContainer {
            display: none;
        }
        .appointment-card, .no-booking-card {
            background: #ffffff;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .appointment-card:hover, .no-booking-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
        }
        .appointment-title {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 15px;
        }
        .appointment-details p {
            font-size: 18px;
            color: #333;
            margin: 5px 0;
        }
        .btn-cancel {
            display: inline-block;
            background: #dc3545;
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-cancel:hover {
            background: #c82333;
        }
        .no-booking-card {
            text-align: center;
            background: #f0f8ff;
            border: 2px dashed #007bff;
            color: #0056b3;
        }
        .no-booking-card h3 {
            font-size: 22px;
            font-weight: bold;
        }
        .no-booking-card p {
            font-size: 16px;
            margin-top: 10px;
        }
        .alert {
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 16px;
            display: flex;
            align-items: center;
        }
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border-left: 5px solid #ff9800;
        }
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 5px solid #dc3545;
        }
        .alert-dismissible .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            line-height: 1;
            cursor: pointer;
            color: inherit;
            margin-left: auto;
        }
    </style>
</head>
<body>
    <%- include('layouts/navbar', { user: user }) %>

    <header class="masthead" style="background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('/img/hero_image.jpg')">
        <div class="container position-relative px-4 px-lg-5">
            <div class="row gx-4 gx-lg-5 justify-content-center">
                <div class="col-md-10 col-lg-8 col-xl-7">
                    <div class="page-heading">
                        <h1 style="color: #ffffff">G2 Registration</h1>
                        <span class="subheading" style="color: #e5e7eb">Enter your details and book an appointment</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="mb-4">
        <div class="container px-4 px-lg-5">
            <div class="row gx-4 gx-lg-5 justify-content-center">
                <div class="col-md-10 col-lg-8 col-xl-7">
                    <% if (message) { %>
                        <div class="alert alert-<%= message.type %>">
                            <%= message.text %>
                            <button type="button" class="close-btn">×</button>
                        </div>
                    <% } %>

                    <form id="g2Form" action="/g2/submit" method="POST">
                        <h3 class="my-4">Personal Information</h3>
                        <div class="form-floating mb-3">
                            <input class="form-control" id="firstName" name="firstname" type="text" 
                                placeholder="Enter your first name..." 
                                value="<%= user?.firstname || '' %>" required />
                            <label for="firstName">First Name</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input class="form-control" id="lastName" name="lastname" type="text" 
                                placeholder="Enter your last name..." 
                                value="<%= user?.lastname || '' %>" required />
                            <label for="lastName">Last Name</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input class="form-control" id="licenseNumber" name="licenseNumber" type="text" 
                                placeholder="Enter your license number..." minlength="8" maxlength="8"
                                value="<%= user?.licenseNumber || '' %>" required />
                            <label for="licenseNumber">License Number</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input class="form-control" id="age" name="age" type="number" 
                                placeholder="Enter your age..." min="18" 
                                value="<%= user?.age || '' %>" required />
                            <label for="age">Age</label>
                        </div>
                        <div class="form-floating mb-3">
                            <select class="form-control" id="testType" name="testType" required>
                                <option value="">Select Your test type</option>
                                <option value="G" <%= user?.testType === 'G' ? 'selected' : '' %>>G</option>
                                <option value="G2" <%= user?.testType === 'G2' ? 'selected' : '' %>>G2</option>
                            </select>
                            <label for="testType">Test Type</label>
                        </div>
                        <h3 class="my-4">Car Information</h3>
                        <div class="form-floating mb-3">
                            <input class="form-control" id="carMake" name="carMake" type="text" 
                                placeholder="Enter car make..." 
                                value="<%= user?.car_details?.carMake || '' %>" required />
                            <label for="carMake">Car Make</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input class="form-control" id="carModel" name="carModel" type="text" 
                                placeholder="Enter car model..." 
                                value="<%= user?.car_details?.carModel || '' %>" required />
                            <label for="carModel">Car Model</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input class="form-control" id="carYear" name="carYear" type="number" 
                                placeholder="Enter car year..." min="1900" max="2025"
                                value="<%= user?.car_details?.carYear || '' %>" required />
                            <label for="carYear">Car Year</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input class="form-control" id="carPlate" name="carPlate" type="text" 
                                placeholder="Enter car plate number..." 
                                value="<%= user?.car_details?.carPlate || '' %>" required />
                            <label for="carPlate">Plate Number</label>
                        </div>

                        <h3 class="my-4">Book Appointment</h3>

                        <% if (appointment && appointment.userId) { %>
                            <div class="alert alert-warning d-flex align-items-center p-4">
                                <span class="me-3" style="font-size: 24px;">⚠</span>
                                <div>
                                    <strong>Notice:</strong> You already have a booking. If you would like to change it, please cancel your current appointment.
                                </div>
                            </div>
                        <% } else { %>
                            <div class="form-floating mb-3">
                                <input class="form-control" id="appointmentDate" name="date" type="text" 
                                       placeholder="Select a date..." 
                                       value="<%= selectedDate || '' %>" required />
                                <label for="appointmentDate">Select Date</label>
                            </div>
                            <div id="timeSlotsContainer">
                                <h5 class="my-3">Available Time Slots</h5>
                                <div class="slot-grid" id="timeSlotsGrid"></div>
                                <input type="hidden" name="appointmentId" id="selectedAppointmentId">
                            </div>        
                            <button class="btn btn-primary text-uppercase" id="submitButton" type="submit" 
                                    <%= selectedDate ? 'style="display: block;"' : 'style="display: none;"' %>>Book Appointment</button>
                        <% } %>     
                    </form>

                    <% if (appointment && appointment.userId) { %>
                        <div class="appointment-card">
                            <h3 class="appointment-title">Your Booked Appointment</h3>
                            <div class="appointment-details">
                                <p><strong>Date:</strong> <%= appointment.date %></p>
                                <p><strong>Time:</strong> <%= appointment.time %></p>
                            </div>
                            <form action="/g2/cancel" method="POST" class="cancel-form">
                                <input type="hidden" name="userId" value="<%= user._id %>">
                                <button class="btn-cancel" type="submit">Cancel Appointment</button>
                            </form>
                        </div>
                    <% } else { %>
                        <div class="no-booking-card">
                            <h3>No Bookings Found</h3>
                            <p>It seems you haven't booked any appointments yet. Select a date and book now!</p>
                        </div>
                    <% } %>

                </div>
            </div>
        </div>
    </main>

    <%- include('layouts/footer') %>
    <%- include('layouts/scripts') %>

    <script src="/js/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script>
        $(document).ready(function () {
            // Datepicker and time slot logic
            const dateInput = $('#appointmentDate');
            const availableAppointments = <%- JSON.stringify(availableAppointments) %>;
            let selectedAppointmentId = null;

            dateInput.datepicker({
                format: 'mm-dd-yyyy',
                autoclose: true,
                startDate: new Date() 
            }).on('changeDate', function (e) {
                const selectedDate = e.format('mm-dd-yyyy');
                $('#selectedDate').val(selectedDate);

                $('#timeSlotsContainer').slideDown();
                $('#submitButton').show();

                const slotsForDate = availableAppointments.filter(app => app.date === selectedDate);
                const slotGrid = $('#timeSlotsGrid');
                slotGrid.empty();

                slotsForDate.forEach(appointment => {
                    const slotBtn = $(`
                        <button type="button" 
                                class="btn slot-btn btn-outline-primary" 
                                data-appointment-id="${appointment._id}">
                            ${appointment.time} ${appointment.time.includes("9") || appointment.time.includes("10") || appointment.time.includes("11") ? 'AM' : 'PM'}
                        </button>
                    `);
                    slotGrid.append(slotBtn);
                });

                $('.slot-btn').click(function () {
                    $('.slot-btn').removeClass('selected');
                    $(this).addClass('selected');
                    selectedAppointmentId = $(this).data('appointment-id');
                    $('#selectedAppointmentId').val(selectedAppointmentId); 
                });
            });

            // Form validation for default names
            $('#g2Form').on('submit', function (event) {
                const firstName = $('#firstName').val().trim().toLowerCase();
                const lastName = $('#lastName').val().trim().toLowerCase();
                const alertContainer = $('#g2Form').prev('.alert-container')?.length 
                    ? $('#g2Form').prev('.alert-container') 
                    : $('<div class="alert-container"></div>').insertBefore('#g2Form');

                // Remove existing default error alerts
                alertContainer.find('.alert-danger.default-error').remove();

                if (firstName === 'default' || lastName === 'default') {
                    event.preventDefault();
                    const alert = $(
                        '<div class="alert alert-danger default-error">' +
                        'Default cannot be used for First Name or Last Name. Please update your details.' +
                        '<button type="button" class="close-btn">×</button></div>'
                    );
                    alertContainer.append(alert);

                    // Close alert on click
                    alert.find('.close-btn').on('click', function () {
                        alert.fadeOut(300, function () {
                            $(this).remove();
                        });
                    });
                }
            });

            // Close existing alerts
            $('.close-btn').on('click', function () {
                $(this).parent('.alert').fadeOut(300, function () {
                    $(this).remove();
                });
            });
        });
    </script>
</body>
</html>